export default class DragDrop{static MOVE_BY=20;static SCROLL_ZONE_HEIGHT=80;static SCROLL_AMOUNT=10;static MOVE_KEYS={38:"N",40:"S",39:"E",37:"W"};static DROP_ANIM_DURATION=300;#e="data-draggable";#t="data-dropzone";#o="data-dragging-box";#s=null;#i=!1;#n=!1;#r=!1;#a=null;#l=null;#h=[];#g=null;#d={mx:null,my:null,boxX:null,boxY:null,dx:null,dy:null};#c={x:0,y:0};#u={value:null,dropbox:null};constructor(){this.#x(this.#e,!0),this.#m()}#b(e){if(0===Object.entries(e).length)return;const{boxAttr:t,dropboxAttr:o,dragboxAttr:s}=e;this.#e=t??"nullAttribute",this.#t=o??"nullAttribute",this.#o=s??"nullAttribute",this.#x(this.#e,!0),this.#x(this.#t,!0)}#x(e,t){setTimeout((()=>{const o=document.querySelectorAll(`[${e}]`);if(0===o.length)throw new Error(`No element found with Attribute "${e}"`);o.forEach((e=>e.setAttribute("tabindex",t?"0":"")))}),10)}#m(){document.addEventListener("mousedown",this.#p),document.addEventListener("mouseup",this.#p),document.addEventListener("mousemove",this.#p),document.addEventListener("keydown",this.#p),document.addEventListener("keyup",this.#p),document.addEventListener("touchstart",this.#p,{passive:!1}),document.addEventListener("touchend",this.#p,{passive:!1}),document.addEventListener("touchmove",this.#p,{passive:!1})}#D(){document.removeEventListener("mousedown",this.#p),document.removeEventListener("mouseup",this.#p),document.removeEventListener("mousemove",this.#p),document.removeEventListener("keydown",this.#p),document.removeEventListener("keyup",this.#p),document.removeEventListener("touchstart",this.#p,{passive:!1}),document.removeEventListener("touchend",this.#p,{passive:!1}),document.removeEventListener("touchmove",this.#p,{passive:!1})}#p=e=>{switch(e.type){case"mousedown":this.#v(e);break;case"mouseup":this.#T(e);break;case"mousemove":this.#B(e);break;case"touchstart":this.#A(e);break;case"touchend":this.#E(e);break;case"touchmove":this.#R(e);break;case"keydown":this.#_(e);break;case"keyup":this.#O(e)}};#v(e){const t=e.target.hasAttribute(this.#e)?e.target:e.target.closest(`[${this.#e}]`);t&&!this.#n&&(e.preventDefault(),this.#y(e,t),this.#w(e),this.#I(e),window.requestAnimationFrame((()=>this.#k(e))))}#A(e){const t=e.target.hasAttribute(this.#e)?e.target:e.target.closest(`[${this.#e}]`);t&&!this.#n&&(this.#y(e,t),this.#w(e),this.#I(e),window.requestAnimationFrame((()=>this.#k(e))))}#I(e){if(this.#a)return;this.#a=this.#s.cloneNode(!0),this.#s.style.opacity=0,this.#a.removeAttribute(this.#e),this.#a.setAttribute(this.#o,"");let{width:t,height:o,x:s,y:i}=this.#s.getBoundingClientRect();s+=window.scrollX,i+=window.scrollY,this.#a.style.cssText=`\n        position: absolute;\n        width: ${t}px;\n        height: ${o}px;\n        top: ${i}px;\n        left: ${s}px;\n        box-shadow: 0 0 10px #00000080;\n        outline: 1px solid gray;\n        z-index: 999;\n        user-select: none;\n      `,document.querySelector("body").append(this.#a),this.#x(this.#e,!1),this.#x(this.#t,!0),this.onDragStart(e)}#k(e){if(this.#n){const t=window.innerHeight,o=this.#c.y,s=parseInt(this.#a.style.top),i=DragDrop.SCROLL_AMOUNT;o<DragDrop.SCROLL_ZONE_HEIGHT&&window.pageYOffset?(window.scrollBy(0,-i),this.#a.style.top=s-i+"px"):o>t-DragDrop.SCROLL_ZONE_HEIGHT&&(window.scrollBy(0,i),this.#a.style.top=s+i+"px"),window.requestAnimationFrame((()=>this.#k(e)))}}#T(e){if((e.target.closest(`[${this.#o}]`)??e.target)!==this.#a)return this.#S(e);this.#n&&(this.#g=this.#C()),this.#g&&this.#f(e),this.#r=!1,this.#c={x:0,y:0},this.#S(e)}#E(e){e.target.closest(`[${this.#o}]`)??e.target;this.#n&&(this.#g=this.#C()),this.#g&&this.#f(e),this.#r=!1,this.#c={x:0,y:0},this.#S(e)}#O(e){if("Tab"!==e.key)return!0;const t=document.activeElement.hasAttribute(this.#t);if(this.#u=t?{value:!0,dropbox:document.activeElement}:{value:!1,dropbox:null},this.onTabKeypress(e),this.#n)return e.preventDefault();this.#i=document.activeElement.hasAttribute(this.#e),this.#i&&(this.#s=document.activeElement)}#_(e){const t=DragDrop.MOVE_KEYS[e.keyCode];if(" "===e.key&&this.#i){if(e.preventDefault(),this.#r)return!0;if(this.#n){this.#g=this.#L();document.activeElement.hasAttribute(this.#t)&&(this.#g=document.activeElement),this.#g&&this.#f(e),this.#S(e)}else this.#n=!0,this.#w(null),this.#G(this.#s)}else{if(this.#r||!t||!this.#a)return;e.preventDefault(),this.#G(this.#a),this.#N(t,e)}this.#n&&(this.#l=this.#s?.parentElement,this.#I(e),this.#h=Array.from(document.querySelectorAll(`[${this.#t}]`)))}#S(e){if(!this.#a)return;const{x:t,y:o}=this.#a.getBoundingClientRect(),{x:s,y:i}=this.#s.getBoundingClientRect(),n=Math.abs(s-t),r=Math.abs(i-o);let a=0;Math.max(n,r)>200&&(a=DragDrop.DROP_ANIM_DURATION),Object.assign(this.#a.style,{transition:a+"ms linear",top:window.scrollY+i+"px",left:window.scrollX+s+"px"}),setTimeout((()=>{this.#s.style.opacity=1,this.#n=!1,this.#s.focus(),this.#a?.remove(),this.#a=null,this.#G(this.#s)}),a),this.#x(this.#e,!0),this.#x(this.#t,!1),this.#u={value:null,dropbox:null},this.onDragEnd(e)}#f(e){const t=this.#s.cloneNode(!0);this.#g.appendChild(t),this.#g.removeAttribute(this.#t),this.#l.setAttribute(this.#t,""),this.#g.removeAttribute("tabindex"),this.#l.setAttribute("tabindex",0),this.#s.remove(),this.#s=t,this.#s.focus(),this.onDrop(e)}#B(e){this.#n&&this.#r&&this.#M(e)}#R(e){this.#n&&this.#r&&(e.preventDefault(),this.#M(e))}#M(e){const{clientX:t,clientY:o}=e.touches?e.touches[0]:e;let s,i;this.#c={x:t,y:o},s=t-this.#d.mx,i=o-this.#d.my;let n=window.scrollX+this.#d.mx+s-this.#d.dx,r=window.scrollY+this.#d.my+i-this.#d.dy;this.#a.style.top=r+"px",this.#a.style.left=n+"px";const a=this.#C();this.#u={value:!!a,dropbox:a},this.onDrag(e)}#N(e,t){const o=parseInt(this.#a.style.top),s=parseInt(this.#a.style.left),i=DragDrop.MOVE_BY;switch(e){case"N":this.#a.style.top=o-i+"px";break;case"S":this.#a.style.top=o+i+"px";break;case"E":this.#a.style.left=s+i+"px";break;case"W":this.#a.style.left=s-i+"px"}const n=this.#L();this.#u={value:!!n,dropbox:n},null===this.onKeyDrag(t)?this.onKeyDrag(t):this.onDrag(t)}#y(e,t){this.#s=t,this.#l=t.parentElement,this.#i=!0,this.#n=!0,this.#r=!0;const{clientX:o,clientY:s}=e.touches?e.touches[0]:e;this.#c={x:o,y:s},this.#h=Array.from(document.querySelectorAll(`[${this.#t}]`))}#w(e){const{left:t,top:o}=this.#s.getBoundingClientRect();if(e)var{clientX:s,clientY:i}=e.touches?e.touches[0]:e;else var s=t,i=o;this.#d={mx:s,my:i,boxX:t,boxY:o,dx:s-t,dy:i-o}}#C(){let{x:e,y:t}=this.#c,o=null;return this.#h.forEach((s=>{let{top:i,bottom:n,left:r,right:a}=s.getBoundingClientRect();t>=i&&t<=n&&e>=r&&e<=a&&(o=s)})),o}#L(){const{top:e,left:t,width:o,height:s}=this.#a.getBoundingClientRect(),i=t+o/2,n=e+s/2;let r=null;return this.#h.forEach((e=>{let t=e.getBoundingClientRect();n>=t.top&&n<=t.bottom&&i>=t.left&&i<=t.right&&(r=e)})),r}#G(e){const t=e.getBoundingClientRect(),o=window.innerWidth||document.documentElement.clientWidth,s=window.innerHeight||document.documentElement.clientHeight;t.bottom>0&&t.right>0&&t.left<o&&t.top<s||e.scrollIntoView({block:"center",behavior:"smooth"})}get droppable(){return this.#u}get draggingBox(){return this.#a}get boxToDrag(){return this.#s}get setDragDropElements(){return this.#b}get addEventListners(){return this.#m}get removeEventListners(){return this.#D}onDragStart=()=>null;onDrag=()=>null;onKeyDrag=()=>null;onDragEnd=()=>null;onDrop=()=>null;onTabKeypress=()=>null}